{"version":3,"sources":["../../lib/express.js"],"names":["fs","require","Benchpress","runtime","evaluate","render","filepath","data","template","next","output","helpers","process","nextTick","e","message","stack","__express","addGlobals","_locals","cache","readFile","err","code","module","exports"],"mappings":"AAAA;;AAEA,MAAMA,KAAKC,QAAQ,IAAR,CAAX;;AAEA,MAAMC,aAAaD,QAAQ,iBAAR,CAAnB;AACA,MAAME,UAAUF,QAAQ,WAAR,CAAhB;AACA,MAAMG,WAAWH,QAAQ,YAAR,CAAjB;;AAEA,SAASI,MAAT,CAAgBC,QAAhB,EAA0BC,IAA1B,EAAgCC,QAAhC,EAA0CC,IAA1C,EAAgD;AAC9C,MAAI;AACF,UAAMC,SAASP,QAAQD,WAAWS,OAAnB,EAA4BJ,IAA5B,EAAkCC,QAAlC,CAAf;;AAEAI,YAAQC,QAAR,CAAiBJ,IAAjB,EAAuB,IAAvB,EAA6BC,MAA7B;AACD,GAJD,CAIE,OAAOI,CAAP,EAAU;AACVA,MAAEC,OAAF,GAAa,8BAA6BT,QAAS,OAAMQ,EAAEC,OAAQ,EAAnE;AACAD,MAAEE,KAAF,GAAW,8BAA6BV,QAAS,OAAMQ,EAAEE,KAAM,EAA/D;;AAEAJ,YAAQC,QAAR,CAAiBJ,IAAjB,EAAuBK,CAAvB;AACD;AACF;;AAED;;;;;;AAMA,SAASG,SAAT,CAAmBX,QAAnB,EAA6BC,IAA7B,EAAmCE,IAAnC,EAAyC;AACvCF,SAAOL,WAAWgB,UAAX,CAAsBX,IAAtB,CAAP;AACAA,OAAKY,OAAL,GAAe,IAAf;;AAEA,MAAIjB,WAAWkB,KAAX,CAAiBd,QAAjB,CAAJ,EAAgC;AAC9BD,WAAOC,QAAP,EAAiBC,IAAjB,EAAuBL,WAAWkB,KAAX,CAAiBd,QAAjB,CAAvB,EAAmDG,IAAnD;AACA;AACD;;AAEDT,KAAGqB,QAAH,CAAYf,QAAZ,EAAsB,OAAtB,EAA+B,CAACgB,GAAD,EAAMC,IAAN,KAAe;AAC5C,QAAID,GAAJ,EAAS;AACPb,WAAKa,GAAL;AACA;AACD;;AAED,QAAId,QAAJ;AACA,QAAI;AACFA,iBAAWN,WAAWkB,KAAX,CAAiBd,QAAjB,IAA6BF,SAASmB,IAAT,CAAxC;AACD,KAFD,CAEE,OAAOT,CAAP,EAAU;AACVA,QAAEC,OAAF,GAAa,gCAA+BT,QAAS,OAAMQ,EAAEC,OAAQ,EAArE;AACAD,QAAEE,KAAF,GAAW,gCAA+BV,QAAS,OAAMQ,EAAEE,KAAM,EAAjE;;AAEAJ,cAAQC,QAAR,CAAiBJ,IAAjB,EAAuBK,CAAvB;AACA;AACD;;AAEDT,WAAOC,QAAP,EAAiBC,IAAjB,EAAuBC,QAAvB,EAAiCC,IAAjC;AACD,GAlBD;AAmBD;;AAEDe,OAAOC,OAAP,GAAiBR,SAAjB","file":"express.js","sourcesContent":["'use strict';\n\nconst fs = require('fs');\n\nconst Benchpress = require('./benchpress.js');\nconst runtime = require('./runtime');\nconst evaluate = require('./evaluate');\n\nfunction render(filepath, data, template, next) {\n  try {\n    const output = runtime(Benchpress.helpers, data, template);\n\n    process.nextTick(next, null, output);\n  } catch (e) {\n    e.message = `Render failed for template ${filepath}:\\n ${e.message}`;\n    e.stack = `Render failed for template ${filepath}:\\n ${e.stack}`;\n\n    process.nextTick(next, e);\n  }\n}\n\n/**\n * Provide functionality to act as an express engine\n * @param {string} filepath - Compiled template file path\n * @param {Object} data - Data with which to parse the template\n * @param {function} next - (err, output)\n */\nfunction __express(filepath, data, next) {\n  data = Benchpress.addGlobals(data);\n  data._locals = null;\n\n  if (Benchpress.cache[filepath]) {\n    render(filepath, data, Benchpress.cache[filepath], next);\n    return;\n  }\n\n  fs.readFile(filepath, 'utf-8', (err, code) => {\n    if (err) {\n      next(err);\n      return;\n    }\n\n    let template;\n    try {\n      template = Benchpress.cache[filepath] = evaluate(code);\n    } catch (e) {\n      e.message = `Evaluate failed for template ${filepath}:\\n ${e.message}`;\n      e.stack = `Evaluate failed for template ${filepath}:\\n ${e.stack}`;\n\n      process.nextTick(next, e);\n      return;\n    }\n\n    render(filepath, data, template, next);\n  });\n}\n\nmodule.exports = __express;\n"]}